<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Livre des T√©moignages ‚Äì Ruth Mulimbi</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:ital,wght@0,300;0,700;1,300;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-wine': '#8a0c4f', /* Bordeaux Profond */
                        'secondary-pink': '#d64d77', /* Rose doux pour l'accentuation */
                        'bg-paper': '#fcfaf9', /* Beige tr√®s clair */
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'display': ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // Variables globales du Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialisation et services
        let app, db, auth;
        const livre = document.getElementById('livre');

        // üíñ LOGIQUE DU CARROUSEL (Corrig√©e pour √™tre en boucle fluide)
        const totalBookImages = 3; 
        const bookCarousel = document.getElementById('bookCarousel');
        let bookCurrentIndex = 0;
        const bookSlideWidth = 100 / (totalBookImages + 1); // Pourcentage de largeur de chaque √©l√©ment (4 au total: 3 + 1 clone)
        const bookTransitionDuration = 1200; // Doit correspondre au CSS

        function startCarousel() {
            if (!bookCarousel) return;

            // Ajout du clone de la premi√®re image (si ce n'est pas d√©j√† fait via HTML)
            // Note: Le clone est d√©j√† ajout√© dans le HTML ci-dessous pour simplifier.

            setInterval(() => {
                bookCurrentIndex++;
                const offset = -bookCurrentIndex * bookSlideWidth; 
                bookCarousel.style.transition = `transform ${bookTransitionDuration / 1000}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
                bookCarousel.style.transform = `translateX(${offset}%)`;

                // Lorsque l'on arrive sur le clone
                if (bookCurrentIndex >= totalBookImages) {
                    setTimeout(() => {
                        // R√©initialiser la position √† la premi√®re image sans transition
                        bookCarousel.style.transition = 'none';
                        bookCurrentIndex = 0;
                        bookCarousel.style.transform = 'translateX(0)';
                    }, bookTransitionDuration); // Attendre que la transition vers le clone soit termin√©e
                }
            }, 6000); // D√©filement toutes les 6 secondes
        }

        // 1. Authentification Firebase
        async function authenticate() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase Auth et connexion OK.");
                loadTestimonials();
                startCarousel(); // D√©marrage du carrousel apr√®s connexion
            } catch (error) {
                console.error("Erreur Firebase au d√©marrage :", error);
                livre.innerHTML = "<p class='text-center text-red-600 mt-10 p-4 bg-white rounded-xl shadow-md'>‚ö†Ô∏è Erreur : Impossible de se connecter √† la base de donn√©es. Assurez-vous que l'application est bien configur√©e ou que les r√®gles de s√©curit√© Firestore sont publiques.</p>";
            }
        }

        // 2. Fonction de partage WhatsApp (Rendue globale)
        window.shareWhatsApp = (message, sender) => {
            // Nettoyage et formatage du message pour l'URL
            const cleanMessage = message.trim();
            const formattedMessage = `Un beau message pour Ruth Mulimbi de la part de *${sender}* :\n\n"${cleanMessage}"\n\n(Livre des Souhaits : ${window.location.href})`;
            const encoded = encodeURIComponent(formattedMessage);
            
            // Ouvre WhatsApp Web/App
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
        };

        // 3. Chargement et affichage des t√©moignages (Real-time via onSnapshot)
        function loadTestimonials() {
            // Chemin d'acc√®s public MANDATOIRE pour le partage
            const collectionPath = `artifacts/${appId}/public/data/testimonials`;
            const testimonialsRef = collection(db, collectionPath);
            
            // Tri du plus r√©cent au plus ancien (plus logique pour un livre d'or)
            const q = query(testimonialsRef, orderBy("timestamp", "desc"));

            // √âcoute en temps r√©el
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    livre.innerHTML = "<p class='text-center text-gray-500 mt-10 p-4 bg-white rounded-xl shadow-md italic'>Aucun t√©moignage n‚Äôa encore √©t√© ajout√©. Soyez le premier √† laisser votre mot !</p>";
                    return;
                }

                livre.innerHTML = ''; // Nettoyer avant d'ins√©rer
                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const name = data.name || "Un admirateur Anonyme";
                    const message = data.message || "Un beau souhait !";
                    
                    // Formatter la date
                    const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
                    const date = timestamp.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    
                    // S√©curiser les cha√Ænes de caract√®res pour l'appel JS
                    const safeMessage = message.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const safeName = name.replace(/'/g, "\\'").replace(/"/g, '\\"');

                    const div = document.createElement('div');
                    div.className = 'testimonial bg-white p-6 md:p-8 mb-6 rounded-xl shadow-lg relative border-l-4 border-primary-wine/70 hover:shadow-xl transition-all duration-300';
                    div.innerHTML = `
                        <div class="testimonial-header flex justify-between items-start mb-4 border-b border-gray-100 pb-2">
                            <strong class="text-xl font-display font-bold text-primary-wine">${name}</strong>
                            <small class="text-gray-500 italic text-sm mt-1">${date}</small>
                        </div>
                        
                        <p class="text-gray-700 whitespace-pre-line text-lg mb-4 font-serif leading-relaxed">${message}</p>
                        
                        <button 
                            onclick="shareWhatsApp('${safeMessage}','${safeName}')" 
                            class="absolute bottom-3 right-3 p-1.5 rounded-full bg-green-500 hover:bg-green-600 transition duration-200 shadow-md transform hover:scale-110 focus:outline-none"
                            aria-label="Partager ce message sur WhatsApp"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-4 h-4">
                                <path d="M12.031 0C5.405 0 0 5.405 0 12.031c0 2.067.531 4.01 1.54 5.71l-.974 3.766 3.868-.973c1.676.953 3.593 1.458 5.497 1.458 6.626 0 12.031-5.405 12.031-12.031C24.062 5.405 18.657 0 12.031 0zm.006 3.018c5.08 0 9.018 3.939 9.018 9.018-.002 1.44-.337 2.84-.969 4.09l-.538 1.055-.47.93-.393.738-1.57 2.822-2.825-1.575-.74-.395-.93-.47-1.055-.537c-1.25.632-2.65.967-4.09.967-5.08 0-9.018-3.939-9.018-9.018s3.938-9.018 9.018-9.018zm.002 3.424c-3.134 0-5.748 2.536-5.748 5.67s2.614 5.67 5.748 5.67 5.748-2.536 5.748-5.67-2.614-5.67-5.748-5.67zm1.14 10.375s-.05.008-.103.008c-.28 0-.547-.034-.798-.094l-.23-.058-2.39-1.24c-.092-.047-.16-.096-.21-.15-.052-.057-.087-.13-.105-.205-.018-.073-.016-.16-.007-.266.007-.105.035-.202.083-.284l.056-.093c.092-.152.285-.357.558-.616.273-.26.54-.5.78-.713.24-.213.435-.41.593-.56.16-.15.286-.285.385-.41.097-.123.155-.224.18-.3.023-.076.02-.15-.01-.22-.03-.07-.087-.15-.17-.235-.083-.085-.183-.192-.298-.322-.116-.13-.23-.263-.34-.4-.112-.137-.197-.28-.258-.427-.06-.146-.088-.287-.088-.42.002-.137.03-.277.086-.42s.14-.29.256-.41.258-.266.44-.45.39-.33.616-.516c.225-.18.423-.33.593-.45.17-.118.318-.21.455-.27.136-.06.286-.09.45-.09.163 0 .317.03.46.09.145.06.28.14.41.25.13.11.23.23.31.36.08.13.126.27.14.4.015.132-.007.27-.064.41s-.137.28-.247.41-.22.25-.37.37-.306.23-.49.33-.36.19-.51.25-.26.1-.34.11zm-5.02-6.522c-.628 0-1.14.505-1.14 1.13s.512 1.13 1.14 1.13 1.14-.505 1.14-1.13-.512-1.13-1.14-1.13zm2.592 0c-.627 0-1.138.505-1.138 1.13s.51-1.13 1.138 1.13 1.138-.505 1.138-1.13-.51-1.13-1.138-1.13zm2.593 0c-.628 0-1.14.505-1.14 1.13s.512 1.13 1.14 1.13 1.14-.505 1.14-1.13-.512-1.13-1.14-1.13z"/>
                            </svg>
                        </button>
                    `;
                    livre.appendChild(div);
                });
            }, (error) => {
                console.error("Erreur onSnapshot Firestore :", error);
                livre.innerHTML = "<p class='text-center text-red-600 mt-10 p-4 bg-white rounded-xl shadow-md'>‚ö†Ô∏è Erreur : Probl√®me de connexion en temps r√©el aux messages. V√©rifiez les r√®gles de s√©curit√© Firestore.</p>";
            });
        }

        document.addEventListener('DOMContentLoaded', authenticate);
    </script>

    <style>
        /* Styles de base pour le corps et la mise en page */
        body {
            font-family: 'Merriweather', serif;
            background-color: theme('colors.bg-paper');
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: theme('colors.gray.800');
        }
        
        main {
            flex-grow: 1;
            max-width: 900px;
            margin: 30px auto;
            width: 95%;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            border-radius: 16px;
            background-color: white; 
            border: 1px solid theme('colors.gray.100');
        }

        /* TYPOGRAPHIE ET TITRES */
        h1 {
            font-family: 'Playfair Display', serif;
            letter-spacing: 2px;
        }

        .intro {
            font-family: 'Merriweather', serif;
            color: theme('colors.gray.600');
            border-bottom: 2px dashed theme('colors.secondary-pink'); 
        }

        /* --- STYLES CARROUSEL (Ajust√© pour la boucle fluide) --- */
        .hero-carousel-container {
            position: relative;
            height: 380px; 
            margin-bottom: 40px;
            overflow: hidden; 
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .carousel-track {
            display: flex;
            /* 3 images + 1 clone = 4 √©l√©ments. Largeur = 400% */
            width: 400%; 
            height: 100%;
            transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .carousel-item {
            /* Chaque √©l√©ment prend 1/4 de la largeur totale */
            width: 25%; 
            flex-shrink: 0;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            filter: brightness(95%);
        }

        /* --- BOUTON D'IMPRESSION STYL√â (AM√âLIOR√â et PROFESSIONNEL) --- */
        .print-button {
            /* D√©grad√© de couleur audacieux */
            background: linear-gradient(135deg, theme('colors.primary-wine'), theme('colors.secondary-pink'));
            
            /* Utilisation des classes Tailwind pour la mise en forme et les effets */
            @apply inline-flex items-center 
                   px-12 py-4 mt-8 
                   rounded-full text-white 
                   text-lg font-extrabold tracking-wider 
                   transition-all duration-300 transform 
                   hover:scale-[1.05] hover:shadow-2xl; /* Effet de zoom et d'ombre au survol */
            
            /* Ombre plus profonde et color√©e pour un effet 3D professionnel */
            box-shadow: 0 10px 30px rgba(138, 12, 79, 0.7); 
            border: 2px solid rgba(255, 255, 255, 0.4); /* Bordure subtile pour le relief */
        }

        /* Changement de couleur au survol pour un meilleur feedback */
        .print-button:hover {
            box-shadow: 0 15px 40px rgba(138, 12, 79, 0.8);
            background: linear-gradient(135deg, theme('colors.secondary-pink'), theme('colors.primary-wine'));
        }
        
        /* FOOTER */
        footer {
            margin-top: auto;
            padding: 30px 0;
            text-align: center;
            font-size: 0.9em;
            color: theme('colors.gray.500');
        }

        /* MEDIA PRINT (Optimisation pour l'impression papier) */
        @media print {
            body {
                background: white; 
                padding: 0;
                margin: 0;
            }
            main {
                box-shadow: none;
                border-radius: 0;
                margin: 0;
                padding: 0;
                width: 100%;
                border: none;
            }
            .print-button, footer, .hero-carousel-container { 
                display: none !important; 
            }
            .testimonial {
                box-shadow: none !important;
                border: 1px dashed #ccc;
                page-break-inside: avoid;
                margin-bottom: 15px;
                padding: 15px;
                border-left: 5px solid theme('colors.primary-wine', 1) !important; 
            }
            .testimonial button { 
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <main>
        <div class="hero-carousel-container">
            <div class="carousel-track" id="bookCarousel">
                <div class="carousel-item"><img src="book_photo1.JPG" alt="Ruth Mulimbi - Photo 1"></div>
                <div class="carousel-item"><img src="book_photo2.JPG" alt="Ruth Mulimbi - Photo 2"></div>
                <div class="carousel-item"><img src="book_photo3.JPG" alt="Ruth Mulimbi - Photo 3"></div>
                <div class="carousel-item"><img src="book_photo1.JPG" alt="Ruth Mulimbi - Photo 1"></div>
            </div>
        </div>

        <h1 class="text-4xl lg:text-5xl text-center mt-0 mb-2">Livre des Souhaits</h1>
        <div class="intro text-center pb-4 mb-10 text-xl italic font-serif">
            ¬´ Un bouquin d‚Äôamour et de b√©n√©dictions pour Ruth Mulimbi, c√©l√©brons la bonne personne qu'elle est. Joyeux Anniversaire Maria ! ¬ª
        </div>

        <div id="livre" class="space-y-6">
            <div class="text-center text-gray-400 p-8">Connexion et chargement des messages...</div>
        </div>

        <div class="flex justify-center mt-12">
            <button onclick="window.print()" class="print-button">
                <svg class="w-7 h-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0l2.585 2.585a2 2 0 002.828 0L17 17m0 0v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4"></path></svg>
                Imprimer ce livre d'or
            </button>
        </div>
    </main>

    <footer>
        <p>‚Äî Gabby Umba 2025 ‚Äî</p>
    </footer>

</body>
</html>
