<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Livre des Témoignages – Ruth Mulimbi</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:ital,wght@0,300;0,700;1,300;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-wine': '#8a0c4f', 
                        'secondary-pink': '#d64d77', 
                        'bg-paper': '#fcfaf9', 
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'display': ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Styles de base pour le corps et la mise en page */
        body {
            font-family: 'Merriweather', serif;
            background-color: theme('colors.bg-paper');
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: theme('colors.gray.800');
        }
        
        main {
            flex-grow: 1;
            max-width: 900px;
            margin: 30px auto;
            width: 95%;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            border-radius: 16px;
            background-color: white; 
            border: 1px solid theme('colors.gray.100');
        }

        /* TYPOGRAPHIE ET TITRES */
        h1 {
            font-family: 'Playfair Display', serif;
            letter-spacing: 2px;
        }

        .intro {
            font-family: 'Merriweather', serif;
            color: theme('colors.gray.600');
            border-bottom: 2px dashed theme('colors.secondary-pink'); 
        }

        /* --- STYLES CARROUSEL --- */
        .hero-carousel-container {
            position: relative;
            height: 380px; 
            margin-bottom: 40px;
            overflow: hidden; 
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .carousel-track {
            display: flex;
            /* 3 images + 1 clone = 4 éléments. Largeur = 400% */
            width: 400%; 
            height: 100%;
            transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .carousel-item {
            /* Chaque élément prend 1/4 de la largeur totale */
            width: 25%; 
            flex-shrink: 0;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            filter: brightness(95%);
        }

        /* --- BOUTON D'IMPRESSION STYLÉ (AMÉLIORÉ et PROFESSIONNEL) --- */
        .print-button {
            background: linear-gradient(135deg, theme('colors.primary-wine'), theme('colors.secondary-pink'));
            @apply inline-flex items-center 
                   px-12 py-4 mt-8 
                   rounded-full text-white 
                   text-lg font-extrabold tracking-wider 
                   transition-all duration-300 transform 
                   hover:scale-[1.05] hover:shadow-2xl; 
            box-shadow: 0 10px 30px rgba(138, 12, 79, 0.7); 
            border: 2px solid rgba(255, 255, 255, 0.4); 
        }

        .print-button:hover {
            box-shadow: 0 15px 40px rgba(138, 12, 79, 0.8);
            background: linear-gradient(135deg, theme('colors.secondary-pink'), theme('colors.primary-wine'));
        }
        
        /* FOOTER */
        footer {
            margin-top: auto;
            padding: 30px 0;
            text-align: center;
            font-size: 0.9em;
            color: theme('colors.gray.500');
        }

        /* MEDIA PRINT (Optimisation pour l'impression papier) */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            main { box-shadow: none; border-radius: 0; margin: 0; padding: 0; width: 100%; border: none; }
            .print-button, footer, .hero-carousel-container, .whatsapp-share-button, .navigation-link { 
                display: none !important; 
            }
            .testimonial {
                box-shadow: none !important;
                border: 1px dashed #ccc;
                page-break-inside: avoid;
                margin-bottom: 15px;
                padding: 15px;
                border-left: 5px solid theme('colors.primary-wine') !important; 
            }
        }
        
        /* Style pour le message d'état */
        .status-message {
            @apply text-center text-lg mt-10 p-4 rounded-xl shadow-inner font-semibold;
        }

        /* Style pour le bouton WhatsApp */
        .whatsapp-share-button {
            @apply absolute bottom-3 right-3 p-1.5 rounded-full bg-green-500 hover:bg-green-600 transition duration-200 shadow-md transform hover:scale-110 focus:outline-none;
        }
    </style>
</head>

<body>
    <main>
        <div class="hero-carousel-container">
            <div class="carousel-track" id="bookCarousel">
                <!-- Ces images sont des placeholders -->
                <div class="carousel-item"><img src="https://placehold.co/800x380/d64d77/ffffff?text=Photo+1" alt="Ruth Mulimbi - Photo 1"></div>
                <div class="carousel-item"><img src="https://placehold.co/800x380/8a0c4f/ffffff?text=Photo+2" alt="Ruth Mulimbi - Photo 2"></div>
                <div class="carousel-item"><img src="https://placehold.co/800x380/d64d77/ffffff?text=Photo+3" alt="Ruth Mulimbi - Photo 3"></div>
                <!-- CLONE OBLIGATOIRE pour la boucle infinie fluide -->
                <div class="carousel-item"><img src="https://placehold.co/800x380/d64d77/ffffff?text=Photo+1" alt="Ruth Mulimbi - Photo 1 (Clone)"></div>
            </div>
        </div>

        <h1 class="text-4xl lg:text-5xl text-center mt-0 mb-2">Livre des Souhaits</h1>
        <div class="intro text-center pb-4 mb-10 text-xl italic font-serif">
            « Un bouquin d’amour et de bénédictions pour **Ruth Mulimbi**, célébrons la bonne personne qu'elle est. Joyeux Anniversaire Maria ! »
        </div>

        <div id="livre" class="space-y-6">
            <div id="loadingStatus" class="status-message text-gray-500 bg-gray-50">Connexion en cours et chargement des messages...</div>
        </div>

        <div class="flex flex-col items-center mt-12 space-y-4">
            <a href="index.html" class="navigation-link text-secondary-pink hover:text-primary-wine font-bold text-lg underline transition duration-200">
                Ajouter mon propre souhait →
            </a>
            <button onclick="window.print()" class="print-button">
                <svg class="w-7 h-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0l2.585 2.585a2 2 0 002.828 0L17 17m0 0v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4"></path></svg>
                Imprimer ce livre d'or
            </button>
        </div>
    </main>

    <footer>
        <p>— Gabby Umba 2025 —</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // --- GESTION DES CONFIGURATIONS CANVAS / FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig = null;
        try {
            // Tente de récupérer la configuration fournie par la plateforme
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if (!firebaseConfig) {
                 // Fallback explicite pour le développement local si les variables Canvas sont absentes
                 console.warn("Variables Canvas Firebase non définies. Si vous exécutez en local, veuillez définir firebaseConfig manuellement.");
            }
        } catch (e) {
            console.error("Erreur de parsing de __firebase_config:", e);
        }

        // Références aux éléments du DOM
        const livre = document.getElementById('livre');
        const loadingStatus = document.getElementById('loadingStatus');

        let db, auth;

        // --- LOGIQUE DU CARROUSEL CORRIGÉE ---
        const totalBookImages = 3; 
        const bookCarousel = document.getElementById('bookCarousel');
        let bookCurrentIndex = 0;
        const bookSlideWidth = 100 / (totalBookImages + 1); 
        const bookTransitionDuration = 1200; 

        function startCarousel() {
            if (!bookCarousel) return;

            // Démarre l'intervalle de défilement
            setInterval(() => {
                bookCurrentIndex++;
                const offset = -bookCurrentIndex * bookSlideWidth; 
                
                // 1. Appliquer la transition pour le mouvement visible
                bookCarousel.style.transition = `transform ${bookTransitionDuration / 1000}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
                bookCarousel.style.transform = `translateX(${offset}%)`;

                // 2. Si on est sur le clone (index 3), revenir à la position de départ (index 0) après la transition
                if (bookCurrentIndex === totalBookImages) { 
                    setTimeout(() => {
                        // Supprimer la transition pour un saut instantané
                        bookCarousel.style.transition = 'none';
                        bookCurrentIndex = 0;
                        bookCarousel.style.transform = 'translateX(0)';
                    }, bookTransitionDuration); // Attendre que le mouvement vers le clone soit terminé
                }
            }, 6000); 
        }

        // --- AUTHENTIFICATION ET INITIALISATION FIREBASE ---
        async function authenticate() {
            if (!firebaseConfig) {
                loadingStatus.textContent = `🚫 ERREUR : Configuration Firebase non trouvée. Impossible de charger les messages.`;
                loadingStatus.className = 'status-message text-red-600 bg-red-100 border border-red-300';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Connexion de l'utilisateur avec le token si disponible, sinon anonymement
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase Auth et connexion OK.");
                loadTestimonials(); 
                startCarousel(); 
            } catch (error) {
                console.error("Erreur Firebase au démarrage :", error);
                loadingStatus.textContent = `🚫 ERREUR FATALE DE CONNEXION : ${error.message}.`;
                loadingStatus.className = 'status-message text-red-600 bg-red-100 border border-red-300';
            }
        }

        // --- FONCTION UTILITAIRE DE PARTAGE WHATSAPP ---
        window.shareWhatsApp = (message, sender) => {
            const cleanMessage = message.trim();
            const formattedMessage = `Un beau message pour Ruth Mulimbi de la part de *${sender}* :\n\n"${cleanMessage}"\n\n(Livre des Souhaits : ${window.location.href})`;
            const encoded = encodeURIComponent(formattedMessage);
            
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
        };

        // --- CHARGEMENT DES TÉMOIGNAGES (Real-time via onSnapshot) ---
        function loadTestimonials() {
            const collectionPath = `artifacts/${appId}/public/data/testimonials`;
            const testimonialsRef = collection(db, collectionPath);
            
            // Tri par timestamp descendant (le plus récent en premier)
            const q = query(testimonialsRef, orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                
                if (loadingStatus) {
                    loadingStatus.remove();
                }

                livre.innerHTML = ''; 

                if (snapshot.empty) {
                    const emptyMessage = document.createElement('p');
                    emptyMessage.className = 'status-message text-gray-500 bg-gray-50 italic border border-gray-200';
                    emptyMessage.textContent = 'Aucun témoignage n’a encore été ajouté. Soyez le premier à laisser votre mot !';
                    livre.appendChild(emptyMessage);
                    return;
                }

                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const name = data.name || "Un admirateur Anonyme";
                    const message = data.message || "Un beau souhait !";
                    
                    const timestamp = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : new Date();
                    const date = timestamp.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    
                    // Sécuriser les chaînes pour l'appel JS
                    const safeMessage = message.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const safeName = name.replace(/'/g, "\\'").replace(/"/g, '\\"');

                    const div = document.createElement('div');
                    div.className = 'testimonial bg-white p-6 md:p-8 mb-6 rounded-xl shadow-lg relative border-l-4 border-primary-wine/70 hover:shadow-xl transition-all duration-300';
                    div.innerHTML = `
                        <div class="testimonial-header flex justify-between items-start mb-4 border-b border-gray-100 pb-2">
                            <strong class="text-xl font-display font-bold text-primary-wine">${name}</strong>
                            <small class="text-gray-500 italic text-sm mt-1">${date}</small>
                        </div>
                        
                        <p class="text-gray-700 whitespace-pre-line text-lg mb-4 font-serif leading-relaxed">${message}</p>
                        
                        <button 
                            onclick="shareWhatsApp('${safeMessage}','${safeName}')" 
                            class="whatsapp-share-button"
                            aria-label="Partager ce message sur WhatsApp"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-4 h-4">
                                <path d="M12.031 0C5.405 0 0 5.405 0 12.031c0 2.067.531 4.01 1.54 5.71l-.974 3.766 3.868-.973c1.676.953 3.593 1.458 5.497 1.458 6.626 0 12.031-5.405 12.031-12.031C24.062 5.405 18.657 0 12.031 0zm.006 3.018c5.08 0 9.018 3.939 9.018 9.018-.002 1.44-.337 2.84-.969 4.09l-.538 1.055-.47.93-.393.738-1.57 2.822-2.825-1.575-.74-.395-.93-.47-1.055-.537c-1.25.632-2.65.967-4.09.967-5.08 0-9.018-3.939-9.018-9.018s3.938-9.018 9.018-9.018zm.002 3.424c-3.134 0-5.748 2.536-5.748 5.67s2.614 5.67 5.748 5.67 5.748-2.536 5.748-5.67-2.614-5.67-5.748-5.67zm1.14 10.375s-.05.008-.103.008c-.28 0-.547-.034-.798-.094l-.23-.058-2.39-1.24c-.092-.047-.16-.096-.21-.15-.052-.057-.087-.13-.105-.205-.018-.073-.016-.16-.007-.266.007-.105.035-.202.083-.284l.056-.093c.092-.152.285-.357.558-.616.273-.26.54-.5.78-.713.24-.213.435-.41.593-.56.16-.15.286-.285.385-.41.097-.123.155-.224.18-.3.023-.076.02-.15-.01-.22-.03-.07-.087-.15-.17-.235-.083-.085-.183-.192-.298-.322-.116-.13-.23-.263-.34-.4-.112-.137-.197-.28-.258-.427-.06-.146-.088-.287-.088-.42.002-.137.03-.277.086-.42s.14-.29.256-.41.258-.266.44-.45.39-.33.616-.516c.225-.18.423-.33.593-.45.17-.118.318-.21.455-.27.136-.06.286-.09.45-.09.163 0 .317.03.46.09.145.06.28.14.41.25.13.11.23.23.31.36.08.13.126.27.14.4.015.132-.007.27-.064.41s-.137.28-.247.41-.22.25-.37.37-.306.23-.49.33-.36.19-.51.25-.26.1-.34.11zm-5.02-6.522c-.628 0-1.14.505-1.14 1.13s.512 1.13 1.14 1.13 1.14-.505 1.14-1.13-.512-1.13-1.14-1.13zm2.592 0c-.627 0-1.138.505-1.138 1.13s.51-1.13 1.138 1.13 1.138-.505 1.138-1.13-.51-1.13-1.138-1.13zm2.593 0c-.628 0-1.14.505-1.14 1.13s.512 1.13 1.14 1.13 1.14-.505 1.14-1.13-.512-1.13-1.14-1.13z"/>
                            </svg>
                        </button>
                    `;
                    livre.appendChild(div);
                });
            }, (error) => {
                console.error("Erreur onSnapshot Firestore :", error);
                livre.innerHTML = '';
                const errorMessage = document.createElement('p');
                errorMessage.className = 'status-message text-red-600 bg-red-100 bg-red-100 border border-red-300';
                errorMessage.textContent = `🚫 Échec de la lecture : Vérifiez vos règles de sécurité Firestore.`;
                livre.appendChild(errorMessage);
            });
        }

        document.addEventListener('DOMContentLoaded', authenticate);
    </script>

</body>
</html>


