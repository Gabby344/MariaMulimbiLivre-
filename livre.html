<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Livre d'Or - Messages pour Ruth</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@300;400;700&family=Sacramento&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-storage-compat.js"></script> 

    <script>
        // Configuration Tailwind harmonis√©e
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-wine': '#8a0c4f',      /* Bordeaux Profond */
                        'secondary-pink': '#e990b0',    /* Rose doux */
                        'bg-paper': '#fffcf8',          /* Fond clair */
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'display': ['Playfair Display', 'serif'],
                        'sacramento': ['Sacramento', 'cursive'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Variables CSS */
        :root {
            --rose-fonce: #8a0c4f;
            --rose-doux: #e990b0;
            --fond: #fffcf8;
            --fond-secondaire: #fef0f4;
            --texte: #3c3c3c;
        }

        body {
            font-family: theme('fontFamily.serif');
            background: linear-gradient(135deg, var(--fond), var(--fond-secondaire));
            color: var(--texte);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            flex-grow: 1;
        }

        /* --- STYLES G√âN√âRAUX --- */
        .main-title {
            color: var(--rose-fonce);
            font-family: theme('fontFamily.display');
            letter-spacing: 3px;
            text-shadow: 2px 3px 5px rgba(0,0,0,0.1); 
            font-weight: 700;
        }
        
        .intro-quote {
            max-width: 650px;
            margin: 30px auto 40px auto;
            font-family: theme('fontFamily.serif');
            font-size: 1.5rem;
            line-height: 1.8;
            color: #555;
            border-left: 5px solid var(--rose-doux);
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.5); 
            border-radius: 5px;
            font-style: italic;
        }

        /* --- Animation d'entr√©e des messages --- */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-message {
            animation: fade-in-up 0.5s ease-out forwards;
            opacity: 0; 
        }
        
        /* Cartes de messages (T√©moignages) */
        .testimonial-card {
            background: #ffffff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid var(--fond-secondaire);
            text-align: left;
            position: relative;
        }
        
        .testimonial-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(to bottom, var(--rose-fonce), var(--rose-doux));
            border-top-left-radius: 15px;
            border-bottom-left-radius: 15px;
        }
        
        .testimonial-name {
            font-family: theme('fontFamily.display');
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--rose-fonce);
            margin-bottom: 5px;
            padding-left: 15px; 
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }
        
        .testimonial-message {
            font-size: 1.1em;
            line-height: 1.6;
            margin-top: 15px;
            padding-left: 15px;
            color: #444;
            font-style: italic;
        }
        
        /* --- Signature Manuscrite --- */
        .testimonial-signature {
            display: block;
            text-align: right;
            margin-top: 20px;
            font-family: theme('fontFamily.sacramento'); 
            font-size: 2.2rem; 
            color: var(--rose-fonce);
            line-height: 1;
            padding-top: 10px;
            border-top: 1px dashed var(--rose-doux);
        }

        .testimonial-date {
            font-size: 0.85rem;
            color: #999;
            font-style: normal; 
            display: block;
            text-align: right;
            margin-top: 5px;
            margin-bottom: 0;
        }

        /* --- Styles des Boutons de R√©actions --- */
        .reaction-btn {
            @apply flex items-center p-1.5 rounded-full transition-all duration-200 
                   border border-transparent bg-gray-50 hover:bg-gray-200;
            cursor: pointer;
            line-height: 1;
        }
        
        .reaction-btn span:first-child {
            /* Emoji */
            margin-right: 4px;
        }

        .reaction-count {
            @apply text-sm font-bold text-primary-wine/90;
        }
        
        /* --- STYLES DES BOUTONS D'ACTION --- */
        .action-button {
            @apply inline-flex items-center justify-center 
                   px-10 py-4 
                   text-xl font-extrabold text-white
                   rounded-full 
                   transition-all duration-300 ease-out; 
            box-shadow: 0 8px 20px rgba(138, 12, 79, 0.5); 
            letter-spacing: 1px;
            text-transform: uppercase;
            width: 300px;
            margin: 15px auto;
        }

        /* --- Carrousel d'images (CORRIG√â) --- */
        .carousel-container {
            width: 100%;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-top: -20px; 
            margin-bottom: 40px;
            position: relative;
            /* Hauteur fixe pour les grands √©crans */
            height: 450px; 
        }
        
        .carousel-track {
            display: flex;
            transition: transform 0.8s ease-in-out;
            height: 100%; /* S'assurer qu'il prend toute la hauteur */
        }

        .carousel-slide {
            min-width: 100%;
            flex-shrink: 0;
            position: relative;
            /* Suppression du padding-bottom: 56.25% qui cr√©ait des espaces blancs non d√©sir√©s */
            height: 100%; 
        }

        .carousel-slide img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Assure que l'image couvre le conteneur sans √™tre d√©form√©e */
            object-position: center;
        }
        
        /* Ajustement pour les petits √©crans (t√©l√©phones) */
        @media (max-width: 768px) {
            .carousel-container {
                height: 250px; /* Hauteur r√©duite pour mobile */
            }
        }

        /* Styles d'impression (inchang√©s) */
        @media print {
            body { background: none; color: #000; font-size: 12pt; }
            main { max-width: none; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            header, footer { display: none; }
            h1, .intro-quote, #messageCount { text-align: center; margin-top: 1em; }
            .testimonial-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 20px; break-inside: avoid; }
            .testimonial-card::before { display: none; }
            .testimonial-name, .testimonial-message, .testimonial-date { padding-left: 0; }
            .testimonial-signature { font-family: Arial, sans-serif !important; font-size: 1.2em; color: #000; border-top: 1px solid #ccc; }
            .carousel-container { display: none; } /* Cacher le carrousel √† l'impression */
        }
    </style>
</head>

<body>
    <header class="no-print">
        <div class="h-5 bg-primary-wine"></div>
    </header>

    <main>
        
        <div class="carousel-container no-print">
            <div class="carousel-track" id="carouselTrack">
                <div class="carousel-slide"><img src="book_photo1.JPG" alt="Ruth Image 1"></div>
                <div class="carousel-slide"><img src="book_photo2.JPG" alt="Ruth Image 2"></div>
                <div class="carousel-slide"><img src="book_photo3.JPG" alt="Ruth Image 3"></div>
            </div>
        </div>

        <h1 class="main-title text-5xl lg:text-6xl text-center mt-12 mb-2 font-extrabold tracking-widest">
            Livre d'Or des Souhaits
        </h1>
        
        <p id="messageCount" class="text-xl font-display text-gray-700 mb-8 font-bold">
            <span class="text-4xl text-primary-wine font-extrabold" id="countValue">...</span> messages enregistr√©s üíñ
        </p>

        <blockquote class="intro-quote">
            ¬´ Un bouquin d'amour et de b√©n√©dictions pour Ruth Mulimbi, c√©l√©brons la bonne personne qu'elle est. Joyeux Anniversaire ! ¬ª
        </blockquote>

        <section id="testimonialsContainer" class="mt-8"></section>

        <div class="no-print flex flex-col items-center justify-center pt-8 pb-16">
            
            <button id="printButton" class="action-button" onclick="window.print()" style="background: linear-gradient(135deg, #4CAF50, #008000);">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v-2a2 2 0 012-2h4a2 2 0 012 2v2m-5 0h2m-7.5 0h3"></path></svg>
                Imprimer le livre
            </button>
            
            <a href="index.html" id="returnButton" class="action-button" style="background: linear-gradient(135deg, var(--rose-fonce), #FF69B4);">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                Retour √† l'accueil
            </a>
        </div>

    </main>

    <footer>
        <span class="text-gray-500 mb-6 block text-sm">--- Gabby Umba 2025 ---</span>
    </footer>


    <script>
        // Initialisation Firebase (compatible v9, SANS AUTH)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'lwangagestion';

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCQdZppl-UsPCXF8iFmXQpcGAFjHEMt838",
                authDomain: "gestion-saint-charles-lwanga.firebaseapp.com",
                projectId: "gestion-saint-charles-lwanga",
                storageBucket: "gestion-saint-charles-lwanga.firebasestorage.app",
                messagingSenderId: "508302363143",
                appId: "1:508302363143:web:35c181528dd84def1a78a2"
            };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // R√©f√©rences aux √©l√©ments du DOM
        const container = document.getElementById('testimonialsContainer');
        const countValue = document.getElementById('countValue');
        const collectionPath = `artifacts/${appId}/public/data/testimonials`;

        // Fonction de formatage de la date (J/M/A)
        const formatDate = (timestamp) => {
            if (!timestamp) return 'Date inconnue';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        };

        // LOGIQUE DES R√âACTIONS
        const handleReaction = async (docId, reactionType, button) => {
            const docRef = db.collection(collectionPath).doc(docId);
            
            try {
                await docRef.update({
                    [`reactions.${reactionType}`]: firebase.firestore.FieldValue.increment(1)
                });

                const countElement = button.querySelector('.reaction-count');
                if (countElement) {
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                }
                
                button.disabled = true;
                button.style.opacity = 0.8;
                button.style.cursor = 'default';

            } catch (error) {
                console.error("Erreur lors de l'enregistrement de la r√©action: ", error);
            }
        };

        // Fonction pour charger et afficher les messages (sans filtre/tri)
        const loadTestimonials = async () => {
            container.innerHTML = '';
            
            try {
                let query = db.collection(collectionPath);
                
                // Ordre par d√©faut : plus r√©cent en premier
                query = query.orderBy('timestamp', 'desc');

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-2xl text-gray-500 mt-16 font-display">Aucun message n\'a encore √©t√© enregistr√©. Soyez le premier !</p>';
                    countValue.textContent = '0';
                    return;
                }
                
                let count = 0;
                let delay = 0;
                const emojiMap = {
                    'love': 'üíñ', 'blessing': 'üôè', 'memory': 'üåü', 'humor': 'üòÇ'
                };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const formattedDate = formatDate(data.timestamp);
                    const emoji = emojiMap[data.category] || ''; 
                    const reactions = data.reactions || { heart: 0, star: 0, party: 0 };
                    count++;
                    
                    const card = document.createElement('div');
                    card.className = 'testimonial-card animate-message';
                    card.style.animationDelay = `${delay}ms`; 
                    
                    card.innerHTML = `
                        <p class="testimonial-message">${emoji} ¬´ ${data.message} ¬ª</p>
                        
                        <div class="mt-6 pt-4 border-t border-gray-100 flex justify-between items-center px-4">
                            <span class="text-sm text-gray-500 italic">Ce message a touch√© :</span>

                            <div class="flex space-x-3">
                                <button class="reaction-btn" data-reaction="heart" data-doc-id="${doc.id}">
                                    <span class="text-2xl">‚ù§Ô∏è</span>
                                    <span class="reaction-count">${reactions.heart}</span>
                                </button>
                                <button class="reaction-btn" data-reaction="party" data-doc-id="${doc.id}">
                                    <span class="text-2xl">ü•≥</span>
                                    <span class="reaction-count">${reactions.party}</span>
                                </button>
                                <button class="reaction-btn" data-reaction="star" data-doc-id="${doc.id}">
                                    <span class="text-2xl">üåü</span>
                                    <span class="reaction-count">${reactions.star}</span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end items-end">
                            <div>
                                <span class="testimonial-date">Le ${formattedDate}</span>
                                <span class="testimonial-signature">${data.name || 'Anonyme'}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                    
                    delay += 100;
                });

                countValue.textContent = count;

            } catch (error) {
                console.error("Erreur de chargement des messages:", error);
                 container.innerHTML = `
                    <div class="mt-16 p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg">
                        <p class="text-xl font-bold font-display">‚ùå Erreur de Connexion √† la base de donn√©es.</p>
                        <p class="mt-2">Veuillez v√©rifier vos r√®gles Firestore (allow read: if true).</p>
                    </div>
                `;
                countValue.textContent = 'Erreur';
            }
        };

        // Logique du Carrousel d'Images (Mise √† jour pour les slides)
        let slideIndex = 0;
        
        const showSlides = () => {
            const slides = document.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;
            const carouselTrack = document.getElementById('carouselTrack');

            if (totalSlides === 0 || !carouselTrack) return;
            
            carouselTrack.style.transform = `translateX(${-slideIndex * 100}%)`;
        };

        const nextSlide = () => {
            const slides = document.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;
            if (totalSlides <= 1) return;

            slideIndex = (slideIndex + 1) % totalSlides;
            showSlides();
        };

        // Chargement initial des messages et d√©marrage du carrousel
        document.addEventListener('DOMContentLoaded', () => {
            loadTestimonials(); 
            
            // D√©marrage du carrousel 
            const totalSlides = document.querySelectorAll('.carousel-slide').length;
            if (totalSlides > 1) {
                showSlides();
                setInterval(nextSlide, 5000); // Change d'image toutes les 5 secondes
            }

            // √âcouteur global pour les boutons de r√©action
            document.addEventListener('click', (e) => {
                const button = e.target.closest('.reaction-btn');
                if (button) {
                    const docId = button.dataset.docId;
                    const reactionType = button.dataset.reaction;
                    handleReaction(docId, reactionType, button);
                }
            });
        });
    </script>
</body>
</html>
