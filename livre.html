<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Livre d'Or - Messages pour Ruth</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@300;400;700&family=Sacramento&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-storage-compat.js"></script> 

    <script>
        // Configuration Tailwind harmonis√©e
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-wine': '#8a0c4f',      /* Bordeaux Profond */
                        'secondary-pink': '#e990b0',    /* Rose doux */
                        'bg-paper': '#fffcf8',          /* Fond clair */
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'display': ['Playfair Display', 'serif'],
                        'sacramento': ['Sacramento', 'cursive'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Variables CSS */
        :root {
            --rose-fonce: #8a0c4f;
            --rose-doux: #e990b0;
            --fond: #fffcf8;
            --fond-secondaire: #fef0f4;
            --texte: #3c3c3c;
        }

        body {
            font-family: theme('fontFamily.serif');
            background: linear-gradient(135deg, var(--fond), var(--fond-secondaire));
            color: var(--texte);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            flex-grow: 1;
        }

        /* --- STYLES G√âN√âRAUX --- */
        .main-title {
            color: var(--rose-fonce);
            font-family: theme('fontFamily.display');
            letter-spacing: 3px;
            text-shadow: 2px 3px 5px rgba(0,0,0,0.1); 
            font-weight: 700;
        }
        
        .intro-quote {
            max-width: 650px;
            margin: 30px auto 40px auto;
            font-family: theme('fontFamily.serif');
            font-size: 1.5rem;
            line-height: 1.8;
            color: #555;
            border-left: 5px solid var(--rose-doux);
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.5); 
            border-radius: 5px;
            font-style: italic;
        }

        /* --- Animation d'entr√©e --- */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-message {
            animation: fade-in-up 0.5s ease-out forwards;
            opacity: 0; 
        }
        
        /* Cartes de messages (T√©moignages) */
        .testimonial-card {
            background: #ffffff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid var(--fond-secondaire);
            text-align: left;
            position: relative;
        }
        
        .testimonial-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(to bottom, var(--rose-fonce), var(--rose-doux));
            border-top-left-radius: 15px;
            border-bottom-left-radius: 15px;
        }
        
        .testimonial-name {
            font-family: theme('fontFamily.display');
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--rose-fonce);
            margin-bottom: 5px;
            padding-left: 15px; 
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }
        
        .testimonial-message {
            font-size: 1.1em;
            line-height: 1.6;
            margin-top: 15px;
            padding-left: 15px;
            color: #444;
            font-style: italic;
        }
        
        /* --- Signature Manuscrite --- */
        .testimonial-signature {
            display: block;
            text-align: right;
            margin-top: 20px;
            font-family: theme('fontFamily.sacramento'); 
            font-size: 2.2rem; 
            color: var(--rose-fonce);
            line-height: 1;
            padding-top: 10px;
            border-top: 1px dashed var(--rose-doux);
        }

        .testimonial-date {
            font-size: 0.85rem;
            color: #999;
            font-style: normal; 
            display: block;
            text-align: right;
            margin-top: 5px;
            margin-bottom: 0;
        }

        /* --- Styles des Boutons de R√©actions --- */
        .reaction-btn {
            @apply flex items-center p-1.5 rounded-full transition-all duration-200 
                   border border-transparent bg-gray-50 hover:bg-gray-200;
            cursor: pointer;
            line-height: 1;
        }
        
        .reaction-btn span:first-child {
            /* Emoji */
            margin-right: 4px;
        }

        .reaction-count {
            @apply text-sm font-bold text-primary-wine/90;
        }
        
        /* --- STYLES DES BOUTONS D'ACTION --- */
        .action-button {
            @apply inline-flex items-center justify-center 
                   px-10 py-4 
                   text-xl font-extrabold text-white
                   rounded-full 
                   transition-all duration-300 ease-out; 
            box-shadow: 0 8px 20px rgba(138, 12, 79, 0.5); 
            letter-spacing: 1px;
            text-transform: uppercase;
            width: 300px;
            margin: 15px auto;
        }
        /* ... (styles d'impression omis pour la concision ici, mais conserv√©s dans le code complet) ... */
    </style>
</head>

<body>
    <header class="no-print">
        <div class="h-5 bg-primary-wine"></div>
    </header>

    <main>
        
        <h1 class="main-title text-5xl lg:text-6xl text-center mt-12 mb-2 font-extrabold tracking-widest">
            Livre d'Or des Souhaits
        </h1>
        
        <p id="messageCount" class="text-xl font-display text-gray-700 mb-8 font-bold">
            <span class="text-4xl text-primary-wine font-extrabold" id="countValue">...</span> messages enregistr√©s üíñ
        </p>

        <blockquote class="intro-quote">
            ¬´ Un bouquin d'amour et de b√©n√©dictions pour Ruth Mulimbi, c√©l√©brons la bonne personne qu'elle est. Joyeux Anniversaire ! ¬ª
        </blockquote>

        <div class="no-print bg-white p-6 rounded-xl shadow-lg mb-10 border-t-4 border-secondary-pink">
            <h3 class="text-xl font-display font-bold text-primary-wine mb-4">Explorer les Souhaits :</h3>
            
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                
                <select id="filterCategory" class="p-3 border rounded-lg w-full md:w-1/2 focus:ring-2 focus:ring-primary-wine/50">
                    <option value="all">‚Äî Afficher toutes les cat√©gories ‚Äî</option>
                    <option value="love">üíñ Mot d'Amour & F√©licitations</option>
                    <option value="blessing">üôè B√©n√©diction & Pri√®re</option>
                    <option value="memory">üåü Souvenir M√©morable</option>
                    <option value="humor">üòÇ Blague & Humour</option>
                </select>

                <select id="sortOrder" class="p-3 border rounded-lg w-full md:w-1/2 focus:ring-2 focus:ring-primary-wine/50">
                    <option value="desc">üóìÔ∏è Du plus R√©cent au plus Ancien</option>
                    <option value="asc">üóìÔ∏è Du plus Ancien au plus R√©cent</option>
                    <option value="name_asc">üî† Par Nom (A-Z)</option>
                </select>
            </div>
        </div>

        <section id="testimonialsContainer" class="mt-8"></section>

        <div class="no-print flex flex-col items-center justify-center pt-8 pb-16">
            
            <button id="printButton" class="action-button" onclick="window.print()" style="background: linear-gradient(135deg, #4CAF50, #008000);">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v-2a2 2 0 012-2h4a2 2 0 012 2v2m-5 0h2m-7.5 0h3"></path></svg>
                Imprimer le livre
            </button>
            
            <a href="index.html" id="returnButton" class="action-button" style="background: linear-gradient(135deg, var(--rose-fonce), #FF69B4);">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                Retour √† l'accueil
            </a>
        </div>

    </main>

    <footer>
        <span class="text-gray-500 mb-6 block text-sm">--- Gabby Umba 2025 ---</span>
    </footer>


    <script>
        // Initialisation Firebase (compatible v9, SANS AUTH)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'lwangagestion';

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCQdZppl-UsPCXF8iFmXQpcGAFjHEMt838",
                authDomain: "gestion-saint-charles-lwanga.firebaseapp.com",
                projectId: "gestion-saint-charles-lwanga",
                storageBucket: "gestion-saint-charles-lwanga.firebasestorage.app",
                messagingSenderId: "508302363143",
                appId: "1:508302363143:web:35c181528dd84def1a78a2"
            };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // R√©f√©rences aux √©l√©ments du DOM
        const container = document.getElementById('testimonialsContainer');
        const countValue = document.getElementById('countValue');
        const collectionPath = `artifacts/${appId}/public/data/testimonials`;

        // Fonction de formatage de la date (J/M/A)
        const formatDate = (timestamp) => {
            if (!timestamp) return 'Date inconnue';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        };

        // LOGIQUE DES R√âACTIONS (J'aime/Adore)
        const handleReaction = async (docId, reactionType, button) => {
            const docRef = db.collection(collectionPath).doc(docId);
            
            try {
                // Incr√©menter atomiquement le champ dans Firestore
                await docRef.update({
                    [`reactions.${reactionType}`]: firebase.firestore.FieldValue.increment(1)
                });

                // Mettre √† jour le compte sur l'interface utilisateur
                const countElement = button.querySelector('.reaction-count');
                if (countElement) {
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                }
                
                // D√©sactiver le bouton pour √©viter les spams
                button.disabled = true;
                button.style.opacity = 0.8;
                button.style.cursor = 'default';

            } catch (error) {
                console.error("Erreur lors de l'enregistrement de la r√©action: ", error);
            }
        };

        // Fonction pour charger et afficher les messages (avec filtre/tri)
        const loadTestimonials = async (categoryFilter = 'all', sortParam = 'timestamp', sortDirection = 'desc') => {
            container.innerHTML = '';
            
            try {
                let query = db.collection(collectionPath);
                
                // 1. Appliquer le Filtre de Cat√©gorie
                if (categoryFilter !== 'all') {
                    query = query.where('category', '==', categoryFilter);
                }

                // 2. Appliquer le Tri
                if (sortParam === 'name') {
                    query = query.orderBy('name', sortDirection);
                    query = query.orderBy('timestamp', 'desc'); 
                } else {
                    query = query.orderBy(sortParam, sortDirection);
                }

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-2xl text-gray-500 mt-16 font-display">Aucun message trouv√© dans cette cat√©gorie/ce tri.</p>';
                    countValue.textContent = '0';
                    return;
                }
                
                let count = 0;
                let delay = 0;
                const emojiMap = {
                    'love': 'üíñ', 'blessing': 'üôè', 'memory': 'üåü', 'humor': 'üòÇ'
                };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const formattedDate = formatDate(data.timestamp);
                    const emoji = emojiMap[data.category] || ''; 
                    const reactions = data.reactions || { heart: 0, star: 0, party: 0 };
                    count++;
                    
                    const card = document.createElement('div');
                    card.className = 'testimonial-card animate-message';
                    card.style.animationDelay = `${delay}ms`; 
                    
                    card.innerHTML = `
                        <p class="testimonial-message">${emoji} ¬´ ${data.message} ¬ª</p>
                        
                        <div class="mt-6 pt-4 border-t border-gray-100 flex justify-between items-center px-4">
                            <span class="text-sm text-gray-500 italic">Ce message a touch√© :</span>

                            <div class="flex space-x-3">
                                <button class="reaction-btn" data-reaction="heart" data-doc-id="${doc.id}">
                                    <span class="text-2xl">‚ù§Ô∏è</span>
                                    <span class="reaction-count">${reactions.heart}</span>
                                </button>
                                <button class="reaction-btn" data-reaction="party" data-doc-id="${doc.id}">
                                    <span class="text-2xl">ü•≥</span>
                                    <span class="reaction-count">${reactions.party}</span>
                                </button>
                                <button class="reaction-btn" data-reaction="star" data-doc-id="${doc.id}">
                                    <span class="text-2xl">üåü</span>
                                    <span class="reaction-count">${reactions.star}</span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end items-end">
                            <div>
                                <span class="testimonial-date">Le ${formattedDate}</span>
                                <span class="testimonial-signature">${data.name || 'Anonyme'}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                    
                    delay += 100;
                });

                countValue.textContent = count;

            } catch (error) {
                console.error("Erreur de chargement des messages:", error);
                if (error.code === 'failed-precondition') {
                    container.innerHTML = `
                        <div class="mt-16 p-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg">
                            <p class="text-xl font-bold font-display">‚ö†Ô∏è Index Manquant pour le Tri !</p>
                            <p class="mt-2">Veuillez cliquer sur le lien dans l'erreur de la console pour cr√©er l'index composite requis dans Firebase pour le tri par Nom.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="mt-16 p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg">
                            <p class="text-xl font-bold font-display">‚ùå Erreur de Connexion √† la base de donn√©es.</p>
                        </div>
                    `;
                }
                countValue.textContent = 'Erreur';
            }
        };

        // Gestion des √©v√©nements de Filtre et de Tri & R√©actions
        document.addEventListener('DOMContentLoaded', () => {
            loadTestimonials(); // Chargement initial
            
            const filterCategory = document.getElementById('filterCategory');
            const sortOrder = document.getElementById('sortOrder');

            const applyFiltersAndSort = () => {
                const category = filterCategory.value;
                const sortValue = sortOrder.value;
                
                let sortParam = 'timestamp';
                let sortDirection = 'desc';

                if (sortValue === 'asc' || sortValue === 'desc') {
                    sortParam = 'timestamp';
                    sortDirection = sortValue;
                } else if (sortValue === 'name_asc') {
                    sortParam = 'name';
                    sortDirection = 'asc';
                }
                
                loadTestimonials(category, sortParam, sortDirection);
            };

            if (filterCategory) filterCategory.addEventListener('change', applyFiltersAndSort);
            if (sortOrder) sortOrder.addEventListener('change', applyFiltersAndSort);

            // √âcouteur global pour les boutons de r√©action
            document.addEventListener('click', (e) => {
                const button = e.target.closest('.reaction-btn');
                if (button) {
                    const docId = button.dataset.docId;
                    const reactionType = button.dataset.reaction;
                    handleReaction(docId, reactionType, button);
                }
            });
        });
    </script>
</body>
</html>
