<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Livre des Témoignages – Ruth Mulimbi</title>

  <!-- Chargement de Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Polices élégantes : Playfair pour les titres, Merriweather pour le corps -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:ital,wght@0,300;0,700;1,300;1,400&display=swap" rel="stylesheet">
  
  <!-- Configuration Tailwind personnalisée pour la couleur primaire -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-wine': '#8a0c4f', /* Bordeaux Profond */
            'secondary-pink': '#d64d77', /* Rose doux pour l'accentuation */
            'bg-paper': '#fcfaf9', /* Beige très clair */
          },
          fontFamily: {
            'serif': ['Merriweather', 'serif'],
            'display': ['Playfair Display', 'serif'],
          }
        }
      }
    }
  </script>

  <!-- Firebase v9 Modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    // Variables globales du Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialisation et services
    let app, db, auth;
    const livre = document.getElementById('livre');

    // 1. Authentification Firebase
    async function authenticate() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            console.log("Firebase Auth et connexion OK.");
            loadTestimonials();
        } catch (error) {
            console.error("Erreur Firebase au démarrage :", error);
            livre.innerHTML = "<p class='text-center text-red-600 mt-10 p-4 bg-white rounded-xl shadow-md'>⚠️ Erreur : Impossible de se connecter à la base de données.</p>";
        }
    }

    // 2. Fonction de partage WhatsApp (Rendue globale)
    window.shareWhatsApp = (message, sender) => {
      // Nettoyage et formatage du message pour l'URL
      const cleanMessage = message.trim();
      const formattedMessage = `Un beau message pour Ruth Mulimbi de la part de *${sender}* :\n\n"${cleanMessage}"\n\n(Livre des Souhaits : ${window.location.href})`;
      const encoded = encodeURIComponent(formattedMessage);
      
      // Ouvre WhatsApp Web/App
      window.open(`https://wa.me/?text=${encoded}`, '_blank');
    };

    // 3. Chargement et affichage des témoignages (Real-time via onSnapshot)
    function loadTestimonials() {
      // Chemin d'accès public MANDATOIRE pour le partage
      const collectionPath = `artifacts/${appId}/public/data/testimonials`;
      const testimonialsRef = collection(db, collectionPath);
      
      // Tri du plus récent au plus ancien (plus logique pour un livre d'or)
      const q = query(testimonialsRef, orderBy("timestamp", "desc"));

      // Écoute en temps réel
      onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
          livre.innerHTML = "<p class='text-center text-gray-500 mt-10 p-4 bg-white rounded-xl shadow-md italic'>Aucun témoignage n’a encore été ajouté. Soyez le premier à laisser votre mot !</p>";
          return;
        }

        livre.innerHTML = ''; // Nettoyer avant d'insérer
        snapshot.forEach(docSnapshot => {
          const data = docSnapshot.data();
          const name = data.name || "Un admirateur Anonyme";
          const message = data.message || "Un beau souhait !";
          
          // Formatter la date
          const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
          const date = timestamp.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
          
          // Sécuriser les chaînes de caractères pour l'appel JS
          const safeMessage = message.replace(/'/g, "\\'").replace(/"/g, '\\"');
          const safeName = name.replace(/'/g, "\\'").replace(/"/g, '\\"');

          const div = document.createElement('div');
          // Utilisation des classes Tailwind pour l'esthétique "professionnelle"
          div.className = 'testimonial bg-white p-6 md:p-8 mb-6 rounded-xl shadow-lg relative border-l-4 border-primary-wine/70 hover:shadow-xl transition-all duration-300';
          div.innerHTML = `
            <div class="testimonial-header flex justify-between items-start mb-4 border-b border-gray-100 pb-2">
              <strong class="text-xl font-display font-bold text-primary-wine">${name}</strong>
              <small class="text-gray-500 italic text-sm mt-1">${date}</small>
            </div>
            
            <p class="text-gray-700 whitespace-pre-line text-lg mb-4 font-serif leading-relaxed">${message}</p>
            
            <!-- Bouton WhatsApp très discret -->
            <button 
              onclick="shareWhatsApp('${safeMessage}','${safeName}')" 
              class="absolute bottom-3 right-3 p-1.5 rounded-full bg-green-500 hover:bg-green-600 transition duration-200 shadow-md transform hover:scale-110 focus:outline-none"
              aria-label="Partager ce message sur WhatsApp"
            >
              <!-- WhatsApp SVG Logo (très petit - w-4 h-4) -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-4 h-4">
                <path d="M12.031 0C5.405 0 0 5.405 0 12.031c0 2.067.531 4.01 1.54 5.71l-.974 3.766 3.868-.973c1.676.953 3.593 1.458 5.497 1.458 6.626 0 12.031-5.405 12.031-12.031C24.062 5.405 18.657 0 12.031 0zm.006 3.018c5.08 0 9.018 3.939 9.018 9.018-.002 1.44-.337 2.84-.969 4.09l-.538 1.055-.47.93-.393.738-1.57 2.822-2.825-1.575-.74-.395-.93-.47-1.055-.537c-1.25.632-2.65.967-4.09.967-5.08 0-9.018-3.939-9.018-9.018s3.938-9.018 9.018-9.018zm.002 3.424c-3.134 0-5.748 2.536-5.748 5.67s2.614 5.67 5.748 5.67 5.748-2.536 5.748-5.67-2.614-5.67-5.748-5.67zm1.14 10.375s-.05.008-.103.008c-.28 0-.547-.034-.798-.094l-.23-.058-2.39-1.24c-.092-.047-.16-.096-.21-.15-.052-.057-.087-.13-.105-.205-.018-.073-.016-.16-.007-.266.007-.105.035-.202.083-.284l.056-.093c.092-.152.285-.357.558-.616.273-.26.54-.5.78-.713.24-.213.435-.41.593-.56.16-.15.286-.285.385-.41.097-.123.155-.224.18-.3.023-.076.02-.15-.01-.22-.03-.07-.087-.15-.17-.235-.083-.085-.183-.192-.298-.322-.116-.13-.23-.263-.34-.4-.112-.137-.197-.28-.258-.427-.06-.146-.088-.287-.088-.42.002-.137.03-.277.086-.42s.14-.29.256-.41.258-.266.44-.45.39-.33.616-.516c.225-.18.423-.33.593-.45.17-.118.318-.21.455-.27.136-.06.286-.09.45-.09.163 0 .317.03.46.09.145.06.28.14.41.25.13.11.23.23.31.36.08.13.126.27.14.4.015.132-.007.27-.064.41s-.137.28-.247.41-.22.25-.37.37-.306.23-.49.33-.36.19-.51.25-.26.1-.34.11zm-5.02-6.522c-.628 0-1.14.505-1.14 1.13s.512 1.13 1.14 1.13 1.14-.505 1.14-1.13-.512-1.13-1.14-1.13zm2.592 0c-.627 0-1.138.505-1.138 1.13s.51 1.13 1.138 1.13 1.138-.505 1.138-1.13-.51-1.13-1.138-1.13zm2.593 0c-.628 0-1.14.505-1.14 1.13s.512 1.13 1.14 1.13 1.14-.505 1.14-1.13-.512-1.13-1.14-1.13z"/>
              </svg>
            </button>
          `;
          livre.appendChild(div);
        });
      }, (error) => {
        console.error("Erreur onSnapshot Firestore :", error);
        livre.innerHTML = "<p class='text-center text-red-600 mt-10'>⚠️ Erreur : Problème de connexion en temps réel aux messages. Vérifiez les règles de sécurité.</p>";
      });
    }

    // Lancement de l'authentification et du chargement des données
    document.addEventListener('DOMContentLoaded', authenticate);
  </script>

  <style>
    /* Styles de base pour le corps et la mise en page */
    body {
      font-family: 'Merriweather', serif;
      background-color: theme('colors.bg-paper');
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: theme('colors.gray.800');
    }
    
    main {
        flex-grow: 1;
        max-width: 900px;
        margin: 30px auto;
        width: 95%;
        padding: 20px;
        /* Ombre douce imitant le relief du livre */
        box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
        border-radius: 16px;
        background-color: white; 
        border: 1px solid theme('colors.gray.100');
    }

    /* TYPOGRAPHIE ET TITRES */
    h1 {
      font-family: 'Playfair Display', serif;
      letter-spacing: 2px;
    }

    .intro {
      font-family: 'Merriweather', serif;
      color: theme('colors.gray.600');
      /* Ligne pointillée élégante */
      border-bottom: 2px dashed theme('colors.secondary-pink'); 
    }

    /* --- IMAGE DE COUVERTURE --- */
    .hero-image-container {
      position: relative;
      height: 350px;
      margin-bottom: 40px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(90%) contrast(105%);
    }

    /* BOUTON D'IMPRESSION STYLÉ */
    .print-button {
      background: linear-gradient(135deg, theme('colors.primary-wine'), theme('colors.secondary-pink'));
      @apply inline-flex items-center px-10 py-3 rounded-xl text-white shadow-xl font-bold tracking-wider transition-all duration-300 transform hover:scale-[1.03];
      box-shadow: 0 8px 20px theme('colors.primary-wine', 0.4);
    }
    
    /* FOOTER */
    footer {
        margin-top: auto;
        padding: 30px 0;
        text-align: center;
        font-size: 0.9em;
        color: theme('colors.gray.500');
    }

    /* MEDIA PRINT (Optimisation pour l'impression papier) */
    @media print {
      body {
        background: white; 
        padding: 0;
        margin: 0;
      }
      main {
        box-shadow: none;
        border-radius: 0;
        margin: 0;
        padding: 0;
        width: 100%;
        border: none;
      }
      .print-button, footer, .hero-image-container { 
        display: none !important; 
      }
      .testimonial {
        box-shadow: none !important;
        border: 1px dashed #ccc;
        page-break-inside: avoid;
        margin-bottom: 15px;
        padding: 15px;
        /* Ajout d'une bordure élégante à l'impression */
        border-left: 5px solid theme('colors.primary-wine', 1) !important; 
      }
      .testimonial button { /* Cache le bouton WhatsApp à l'impression */
          display: none !important;
      }
    }
  </style>
</head>

<body class="bg-bg-paper">
  
  <main>
    <!-- Image de couverture élégante et responsive -->
    <div class="hero-image-container">
      <img 
        src="https://placehold.co/900x350/8a0c4f/ffffff?text=Livre+d'Or+pour+Ruth+Mulimbi" 
        onerror="this.onerror=null;this.src='https://placehold.co/900x350/8a0c4f/ffffff?text=Livre+d%27Or+pour+Ruth+Mulimbi'" 
        alt="Photo de couverture du livre des témoignages" 
        class="hero-image"
      />
    </div>

    <h1 class="text-4xl lg:text-5xl text-center mt-0 mb-2">Livre des Souhaits</h1>
    <div class="intro text-center pb-4 mb-10 text-xl italic font-serif">
        « Un bouquin d’amour et de bénédictions pour Ruth Mulimbi, célébrons la bonne personne qu'elle est. Joyeux Anniversaire Maria ! »
    </div>

    <div id="livre" class="space-y-6">
      <!-- Les témoignages seront insérés ici par JavaScript -->
      <div class="text-center text-gray-400 p-8">Connexion et chargement des messages...</div>
    </div>

    <div class="flex justify-center mt-12">
        <button onclick="window.print()" class="print-button">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0l2.585 2.585a2 2 0 002.828 0L17 17m0 0v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4"></path></svg>
            Imprimer ce livre d'or
        </button>
    </div>
  </main>

  <footer>
    <p>— Créé avec Amour par Gabby Umba, 2025 —</p>
  </footer>

</body>
</html>


