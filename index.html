<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ajouter un Souhait ‚Äì Livre des T√©moignages</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:ital,wght@0,300;0,700;1,300;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-wine': '#8a0c4f', /* Bordeaux Profond */
                        'secondary-pink': '#d64d77', /* Rose doux pour l'accentuation */
                        'bg-paper': '#fcfaf9', /* Beige tr√®s clair */
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'display': ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Merriweather', serif;
            background-color: theme('colors.bg-paper');
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: theme('colors.gray.800');
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
            padding: 30px;
            background-color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            border-radius: 16px;
            border: 1px solid theme('colors.gray.100');
        }

        h1 {
            font-family: 'Playfair Display', serif;
            letter-spacing: 1px;
        }

        .submit-button {
            /* D√©grad√© de couleur audacieux */
            background: linear-gradient(135deg, theme('colors.primary-wine'), theme('colors.secondary-pink'));
            
            /* Utilisation des classes Tailwind pour la mise en forme et les effets */
            @apply w-full inline-flex justify-center items-center 
                   px-8 py-3 mt-6 
                   rounded-lg text-white 
                   text-lg font-extrabold tracking-wider 
                   transition-all duration-300 transform 
                   hover:scale-[1.01] hover:shadow-2xl; 
            
            /* Ombre plus profonde et color√©e pour un effet 3D professionnel */
            box-shadow: 0 5px 20px rgba(138, 12, 79, 0.5); 
        }

        .submit-button:hover {
            box-shadow: 0 8px 30px rgba(138, 12, 79, 0.7);
        }

        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-wine focus:border-primary-wine transition duration-200;
        }
        
        .message-box {
            @apply w-full p-4 border border-gray-300 rounded-lg h-32 resize-none focus:ring-primary-wine focus:border-primary-wine transition duration-200;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-3xl text-center text-primary-wine mb-2">Ajoutez Votre Souhait</h1>
        <p class="text-center text-gray-500 mb-8 font-serif">Partagez votre b√©n√©diction pour Ruth Mulimbi.</p>

        <form id="testimonialForm">
            <div class="mb-4">
                <label for="name" class="block text-gray-700 font-semibold mb-2">Votre Nom (ou Surnom) :</label>
                <input type="text" id="name" name="name" class="input-field" placeholder="Ex: Gabby Umba" required>
            </div>

            <div class="mb-4">
                <label for="message" class="block text-gray-700 font-semibold mb-2">Votre Message de B√©n√©diction :</label>
                <textarea id="message" name="message" class="message-box" placeholder="√âcrivez ici votre message d'amour et de b√©n√©diction..." required></textarea>
            </div>

            <button type="submit" class="submit-button" id="submitBtn">
                <span id="buttonText">Envoyer Mon Souhait</span>
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>
        
        <div id="statusMessage" class="mt-4 p-3 text-center rounded-lg hidden" role="alert"></div>

        <div class="text-center mt-6">
            <a href="livre.html" class="text-secondary-pink hover:text-primary-wine font-bold underline transition duration-200">
                ‚Üí Voir tous les souhaits dans le Livre
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // --- GESTION DES CONFIGURATIONS CANVAS / FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig = null;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) {
            console.error("Erreur de parsing de __firebase_config:", e);
        }

        // R√©f√©rences DOM
        const form = document.getElementById('testimonialForm');
        const submitBtn = document.getElementById('submitBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');

        let db, auth;

        // --- AUTHENTIFICATION ET INITIALISATION FIREBASE ---
        async function authenticate() {
            if (!firebaseConfig) {
                statusMessage.textContent = "Erreur: Configuration Firebase non trouv√©e. L'envoi est d√©sactiv√©.";
                statusMessage.className = 'mt-4 p-3 text-center rounded-lg bg-red-100 text-red-700 block';
                submitBtn.disabled = true;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Connexion de l'utilisateur (anonyme ou avec custom token)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase Auth OK.");
                form.addEventListener('submit', handleSubmit);
            } catch (error) {
                console.error("Erreur Firebase au d√©marrage :", error);
                statusMessage.textContent = `Erreur de connexion Firebase: ${error.message}.`;
                statusMessage.className = 'mt-4 p-3 text-center rounded-lg bg-red-100 text-red-700 block';
                submitBtn.disabled = true;
            }
        }

        // --- GESTION DE L'ENVOI DU FORMULAIRE ---
        async function handleSubmit(event) {
            event.preventDefault();

            // Afficher le chargement
            submitBtn.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            statusMessage.classList.add('hidden');

            const name = document.getElementById('name').value.trim() || "Anonyme";
            const message = document.getElementById('message').value.trim();

            if (message.length < 5) {
                displayMessage("Veuillez √©crire un message un peu plus long (min. 5 caract√®res).", 'bg-yellow-100', 'text-yellow-700');
                resetButton();
                return;
            }

            try {
                // Le chemin public correspondant aux r√®gles Firestore
                const collectionPath = `artifacts/${appId}/public/data/testimonials`;
                
                await addDoc(collection(db, collectionPath), {
                    name: name,
                    message: message,
                    timestamp: serverTimestamp() // Utilise le timestamp du serveur pour un tri pr√©cis
                });

                displayMessage("üéâ Votre souhait a √©t√© envoy√© avec succ√®s ! Il appara√Æt dans le Livre.", 'bg-green-100', 'text-green-700');
                form.reset(); // Vider le formulaire apr√®s succ√®s
            } catch (error) {
                console.error("Erreur lors de l'envoi du message :", error);
                displayMessage(`Erreur d'envoi. Cause probable: ${error.message}`, 'bg-red-100', 'text-red-700');
            } finally {
                resetButton();
            }
        }

        // --- FONCTIONS UTILITAIRES D'INTERFACE ---
        function displayMessage(text, bgColor, textColor) {
            statusMessage.textContent = text;
            statusMessage.className = `mt-4 p-3 text-center rounded-lg ${bgColor} ${textColor} block`;
        }

        function resetButton() {
            submitBtn.disabled = false;
            buttonText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', authenticate);
    </script>
</body>
</html>


